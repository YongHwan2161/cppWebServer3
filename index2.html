<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Document Title</title>
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        #clock {
            color: green;
            display: inline-block;
        }

        #loginForm {
            width: 300px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f2f2f2;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #loginForm div {
            margin-bottom: 15px;
        }

        #loginForm label {
            display: block;
            margin-bottom: 5px;
        }

        #loginForm input[type="text"],
        #loginForm input[type="password"] {
            width: calc(100% - 10px);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        #loginForm button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: #fff;
            cursor: pointer;
        }

        #loginForm button[type="submit"] {
            background-color: #28a745;
        }

        #loginForm button[type="submit"]:hover,
        #loginForm button[type="button"]:hover {
            background-color: #0056b3;
        }

        #filecontent {
            display: none;
        }

        #saveFileChanges {
            display: none;
        }

        #contents,
        #info {
            display: inline-block;
            max-width: 500px;
            overflow-wrap: break-word;
        }

        textarea {
            width: 40%;
            margin-bottom: 10px;
        }

        .button {
            background-color: #007bff;
            border: none;
            color: white;
            padding: 2px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 11px;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 1px;
        }

        .button:hover {
            background-color: #0056b3;
        }

        .home-button {
            display: inline-block;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 15px;
            text-align: center;
            line-height: 30px;
            text-decoration: none;
            box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.5);
        }

        .home-button:hover {
            background-color: #0056b3;
        }

        canvas {
            width: 100vw;
            height: 100vh;
            display: block;
        }

        #ui {
            width: 200px;
        }
    </style>
</head>

<body onload="start()">
    <!-- 홈 버튼 -->
    <a href="#" class="home-button" onclick="sendTextToServer('start')"><i class="fas fa-home"></i></a>
    <div id="clock"></div><br />
    <form id="loginForm">
        <div>
            <label for="username">Username:</label>
            <input type="text" id="username" name="username" required>
        </div>
        <div>
            <label for="password">Password:</label>
            <input type="password" id="password" name="password" required>
        </div>
        <div>
            <button type="submit">Login</button>
            <button type="button" onclick="location.href='/signup.html'">Sign Up</button>
        </div>
    </form>
    <div id="contents"></div><br />
    <textarea id="textinput" placeholder="Enter text..."></textarea><br />
    <button class="button" id="Button_Save" onclick="sendTextToServer('save')">Save</button>
    <button class="button" id="Button_Enter"
        onclick="sendTextToServer(document.getElementById('textinput').value)">Enter</button>
    <button class="button" id="Button_Review" onclick="sendTextToServer('98')">Review</button><br />
    <div id="info"></div><br />
    <div id="Log"></div><br />
    <textarea id="fileContent" rows="1"></textarea><br />
    <button id="saveFileChanges" onclick="saveFileChanges()">Save Changes</button>
    <canvas id="c"></canvas>
    <div id="uiContainer">
        <div id="ui">
            <div id="x"></div>
            <div id="y"></div>
            <div id="rotation"></div>
        </div>
    </div>
    <script id="vertex-shader-2d" type="notjs">

    // an attribute will receive data from a buffer
    attribute vec2 a_position;
    uniform vec2 u_resolution;
    uniform vec2 u_translation;
    uniform vec2 u_rotation;
    
    // all shaders have a main function
    void main() {
        // 위치 회전
        vec2 rotatedPosition = vec2(
           a_position.x * u_rotation.y + a_position.y * u_rotation.x,
           a_position.y * u_rotation.y - a_position.x * u_rotation.x);
        // 평행 이동 추가
        vec2 position = rotatedPosition + u_translation;

        // 위치를 픽셀에서 0.0과 1.0사이로 변환
        vec2 zeroToOne = position / u_resolution;

        // 0->1에서 0->2로 변환
        vec2 zeroToTwo = zeroToOne * 2.0;
     
        // 0->2에서 -1->+1로 변환 (클립 공간)
        vec2 clipSpace = zeroToTwo - 1.0;
     
        gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);
    }
  
  </script>
    <script id="fragment-shader-2d" type="notjs">

    // fragment shaders don't have a default precision so we need
    // to pick one. mediump is a good default
    precision mediump float;
    uniform vec4 u_color;
    
    void main() {
        gl_FragColor = u_color;
      }
  
  </script>
    </script>
    <script src="https://webglfundamentals.org/webgl/resources/jquery-1.7.1.min.js"></script>
    <script src="https://webglfundamentals.org/webgl/resources/jquery-ui-1.8.16.custom.min.js"></script>
    <script src="https://webglfundamentals.org/webgl/resources/jquery.mousecapture.js"></script>
    <script src="https://webglfundamentals.org/webgl/resources/jquery.gman.ui.js"></script>
    <script src="https://webglfundamentals.org/webgl/resources/jquery-gman-circle.js"></script>
    <!--
  for most samples webgl-utils only provides shader compiling/linking and
  canvas resizing because why clutter the examples with code that's the same in every sample.
  See https://webglfundamentals.org/webgl/lessons/webgl-boilerplate.html
  and https://webglfundamentals.org/webgl/lessons/webgl-resizing-the-canvas.html
  for webgl-utils, m3, m4, and webgl-lessons-ui.
  -->
    <script src="https://webglfundamentals.org/webgl/resources/webgl-utils.js"></script>
    <script src="https://webglfundamentals.org/webgl/resources/webgl-lessons-ui.js"></script>

    <script>
        let user = 0, node = 0, ch = 0;
        function updateClock() {
            document.getElementById("clock").textContent = new Date().toLocaleTimeString();
        }

        function sendTextToServer(textinput) {
            //const textinput = document.getElementById("textinput").value;
            const fileContent = document.getElementById('fileContent').value;
            const additionalContent = textinput === "editHtml" ? `\t${fileContent}` : (textinput === "editcppl" ? `\t${fileContent}` : '');
            const text = `${user}\t${node}\t${ch}\t${textinput}${additionalContent}`;

            const xhr = new XMLHttpRequest();
            xhr.open('POST', 'https://obscure-space-train-v9xrjvg795p2rx5-8080.app.github.dev/', true);
            xhr.setRequestHeader('Content-Type', 'text/plain; charset=utf-8');
            xhr.onload = function () {
                if (xhr.status === 200) {
                    const res = xhr.responseText.split('\t');
                    updateUI(res);
                } else {
                    console.error('Error:', xhr.status, xhr.statusText);
                    document.getElementById("contents").textContent = `An error occurred: ${xhr.status} ${xhr.statusText}`;
                }
            };
            xhr.onerror = function () {
                console.error('Request failed.');
            };
            xhr.send(text);
            document.getElementById("textinput").focus();
        }
        function updateUI(res) {
            user = res[0];
            node = res[1];
            ch = res[2];
            const contents = document.getElementById("contents");
            const info = document.getElementById("info");
            if (res[5] === "html") {
                document.getElementById('fileContent').value = res[3];
            } else if (res[5] === "cpp") {
                document.getElementById('fileContent').value = res[3];
            } else {
                contents.innerHTML = res[3];
            }
            info.textContent = `user: ${res[0]}, node: ${res[1]}/${res[4]}, ch: ${res[2]}, Last: ${res[6]}`;
            document.getElementById("textinput").value = res[5];
            console.log(res);
        }
        function saveFileChanges() {
            if (document.getElementById("textinput").value === "html") {
                document.getElementById("textinput").value = "editHtml";
            } else {
                document.getElementById("textinput").value = "editcpp";
            }
            sendTextToServer();
            //location.reload();
        }
        window.onload = function () {
            document.getElementById('Log').innerText = 'Page is fully loaded.';
            updateClock();
            setInterval(updateClock, 1000);
            sendTextToServer();
        }
        document.getElementById("loginForm").addEventListener("submit", function (event) {
            event.preventDefault(); // Prevent the form from submitting

            var formData = new FormData(this); // Collect form data

            fetch("/login", {
                method: "POST",
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .then(data => {
                    // Handle successful login response
                    const res = data.split('\t');
                    updateUI(res);
                    // Hide the login form
                    document.getElementById("loginForm").style.display = "none";
                    //console.log(data); // Do whatever processing you need with the response data
                })
                .catch(error => {
                    // Handle error
                    console.error('There was a problem with the fetch operation:', error);
                });
        });

        /* eslint no-console:0 consistent-return:0 */
        "use strict";

        function main() {
            // Get A WebGL context
            /** @type {HTMLCanvasElement} */
            var canvas = document.querySelector("#c");
            var gl = canvas.getContext("webgl");
            if (!gl) {
                return;
            }

            // setup GLSL program
            var program = webglUtils.createProgramFromScripts(gl, ["vertex-shader-2d", "fragment-shader-2d"]);
            gl.useProgram(program);

            // look up where the vertex data needs to go.
            var positionLocation = gl.getAttribLocation(program, "a_position");

            // lookup uniforms
            var resolutionLocation = gl.getUniformLocation(program, "u_resolution");
            var colorLocation = gl.getUniformLocation(program, "u_color");
            var translationLocation = gl.getUniformLocation(program, "u_translation");
            var rotationLocation = gl.getUniformLocation(program, "u_rotation");

            // Create a buffer to put positions in
            var positionBuffer = gl.createBuffer();
            // Bind it to ARRAY_BUFFER (think of it as ARRAY_BUFFER = positionBuffer)
            gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
            // Put geometry data into buffer
            setGeometry(gl);

            var translation = [0, 0];
            var color = [Math.random(), Math.random(), Math.random(), 1];
            var rotation = [0, 1];

            drawScene();

            // Setup a ui.
            webglLessonsUI.setupSlider("#x", { slide: updatePosition(0), max: gl.canvas.width });
            webglLessonsUI.setupSlider("#y", { slide: updatePosition(1), max: gl.canvas.height });

            function updatePosition(index) {
                return function (event, ui) {
                    translation[index] = ui.value;
                    drawScene();
                };
            }

            // Draw the scene.
            function drawScene() {
                webglUtils.resizeCanvasToDisplaySize(gl.canvas);

                // Tell WebGL how to convert from clip space to pixels
                gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);

                // Clear the canvas.
                gl.clear(gl.COLOR_BUFFER_BIT);

                // Tell it to use our program (pair of shaders)
                gl.useProgram(program);

                // Turn on the attribute
                gl.enableVertexAttribArray(positionLocation);

                // Bind the position buffer.
                gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);

                // Tell the attribute how to get data out of positionBuffer (ARRAY_BUFFER)
                var size = 2;          // 2 components per iteration
                var type = gl.FLOAT;   // the data is 32bit floats
                var normalize = false; // don't normalize the data
                var stride = 0;        // 0 = move forward size * sizeof(type) each iteration to get the next position
                var offset = 0;        // start at the beginning of the buffer
                gl.vertexAttribPointer(
                    positionLocation, size, type, normalize, stride, offset);

                // set the resolution
                gl.uniform2f(resolutionLocation, gl.canvas.width, gl.canvas.height);

                // set the color
                gl.uniform4fv(colorLocation, color);

                // Set the translation.
                gl.uniform2fv(translationLocation, translation);

                // 회전 설정
                gl.uniform2fv(rotationLocation, rotation);

                // Draw the geometry.
                var primitiveType = gl.TRIANGLES;
                var offset = 0;
                var count = 18;  // 6 triangles in the 'F', 3 points per triangle
                gl.drawArrays(primitiveType, offset, count);
            }
        }

        // Fill the buffer with the values that define a letter 'F'.
        function setGeometry(gl) {
            gl.bufferData(
                gl.ARRAY_BUFFER,
                new Float32Array([
                    // left column
                    0, 0,
                    30, 0,
                    0, 150,
                    0, 150,
                    30, 0,
                    30, 150,

                    // top rung
                    30, 0,
                    100, 0,
                    30, 30,
                    30, 30,
                    100, 0,
                    100, 30,

                    // middle rung
                    30, 60,
                    67, 60,
                    30, 90,
                    30, 90,
                    67, 60,
                    67, 90,
                ]),
                gl.STATIC_DRAW);
        }

        main();

    </script>
</body>

</html>